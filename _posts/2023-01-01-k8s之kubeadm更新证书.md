---
layout:     post
title:       k8s的证书更新
subtitle:    k8s的证书更新
date:       2023-01-01
author:     eddie
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - k8s
---

###  检查过期时间

```
kubeadm alpha certs check-expiration
```
15:53 root@ksit-master.162.30:~ # kubeadm alpha certs check-expiration
Command "check-expiration" is deprecated, please use the same command under "kubeadm certs"
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Jun 13, 2025 13:58 UTC   364d            ca                      no      
apiserver                  Jun 13, 2025 13:58 UTC   364d            ca                      no      
apiserver-etcd-client      Jun 13, 2025 13:58 UTC   364d            etcd-ca                 no      
apiserver-kubelet-client   Jun 13, 2025 13:58 UTC   364d            ca                      no      
controller-manager.conf    Jun 13, 2025 13:58 UTC   364d            ca                      no      
etcd-healthcheck-client    Jun 13, 2025 13:58 UTC   364d            etcd-ca                 no      
etcd-peer                  Jun 13, 2025 13:58 UTC   364d            etcd-ca                 no      
etcd-server                Jun 13, 2025 13:58 UTC   364d            etcd-ca                 no      
front-proxy-client         Jun 13, 2025 13:58 UTC   364d            front-proxy-ca          no      
scheduler.conf             Jun 13, 2025 13:58 UTC   364d            ca                      no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      May 22, 2123 03:05 UTC   98y             no      
etcd-ca                 May 22, 2123 03:05 UTC   98y             no      
front-proxy-ca          May 22, 2123 03:05 UTC   98y             no     
```

### 证书备份

```
cp -rp /etc/kubernetes /etc/kubernetes.bak1
```

### 重新生成证书(新版kubeadm(1.15以上)不用删除旧证书，旧版需要删除旧证书/etc/kubernetes/pki/*)

```
kubeadm alpha certs renew all  (生成所有证书)
kubeadm alpha certs renew apiserver (生成某个组件的证书)
```

### 备份旧配置文件

```
mv /etc/kubernetes/*.conf /tmp/kubernetes
```

### 重新生成配置文件

```
kubeadm alpha phase kubeconfig all (生成所有配置文件)
kubeadm init phase kubeconfig admin (生成 admin 配置文件)
``` 


### 复制新证书给kubectl
```
cp /etc/kubernetes/admin.conf /root/.kube/config
```

### 重启kubelet

```
systemctl restart kubelet
```

### 证书过期时间确认
```
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep ' Not '
```

### 集群确认
```
kubectl get cs
```
注意：如果发现集群，能读不能写，则请重启一下组件：apiserver ,schedulerdocker,controller-managerdocker
