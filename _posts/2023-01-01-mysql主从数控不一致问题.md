---
layout:     post
title:       mysql的主从复制数据补一致
subtitle:    mysql的主从复制数据补一致
date:       2023-01-01
author:     eddie
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - mysql
---

## 问题

mysql主从数据库数据不一致问题 从库的sql进程和io进程都是yes但是从数据库的数据没有同步过来

## 原因
mysql5.7  主数据库执行replace语句的时候 执行的删除记录再新增记录，自增主键会变化，REPLACE INTO操作对应的binlog日志记录其实是update操作，从库节点在应用update操作时，发现命中数据时，对应的autoincrement是没有变化的


## 解决方案
1. 升级到mysql8.0版本 
   
     AUTO_INCREMENT值做了持久化，且在做更新操作时，会将表上的自增列被更新为比auto_increment更大的值，auto_increment值也将被更新。

2. 禁用 replace into 操作
   
   业务侧禁用replace into 或 insert ... on duplicate  key update ,实现方式可以通过代码逻辑来实现。

## 如何巡检
1. 查找auto_increment 属性的表，
```
select TABLE_SCHEMA,TABLE_NAME,AUTO_INCREMENT from information_schema.tables where table_schema not in ('information_schema','mysql','performance_schema','sys') AUTO_INCREMENTis not null \G

```
2. 给表枷锁
```
lock tables table_name write;
```  

3. 读取数据和表auto_increment值进行比对
 ```
MAXID=select max(id) from table_name;
AUTO_INCREMENT=select AUTO_INCREMENT from information_schema.tables where TABLE_NAME='t1' ;
```

4. 判断条件
   
    如果MAXID >= AUTO_INCREMENT , 判断为异常




